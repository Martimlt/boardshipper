{% extends 'base.html' %}

{% block title %}Book Your Shipment - BoardShipper{% endblock %}

{% block content %}
    <!-- Book It Section -->
    <section class="page-section">
        <div class="container">
            <h1 style="text-align: center; font-size: 2.5rem; margin-bottom: 3rem; margin-top: 3rem; color: #4a90e2;">Book Your Shipment</h1>
            
            {% if show_welcome and user.profile.business_name %}
                <div id="welcome-message" style="text-align: center; color: #4a90e2; font-size: 1.2rem; margin-top: -20px; padding-top: 0; margin-bottom: 2rem; transition: opacity 0.5s ease;">
                    Welcome, {{ user.profile.business_name }}!
                </div>
                <script>
                    setTimeout(function() {
                        var welcomeMsg = document.getElementById('welcome-message');
                        if (welcomeMsg) {
                            welcomeMsg.style.opacity = '0';
                            setTimeout(function() {
                                welcomeMsg.style.display = 'none';
                            }, 500);
                        }
                    }, 5000);
                </script>
            {% endif %}
            
            {% if form.non_field_errors %}
                <div class="alert-message alert-error" style="background-color: #f8d7da; color: #721c24; padding: 15px; margin-bottom: 15px; border-radius: 4px; position: relative;">
                    {% for error in form.non_field_errors %}
                        {{ error }}<br>
                    {% endfor %}
                    <button type="button" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 20px; cursor: pointer; color: inherit; opacity: 0.7;" onclick="this.parentElement.remove()">Ã—</button>
                </div>
            {% endif %}
            
            <form class="booking-form" id="bookingForm" method="POST">
                {% csrf_token %}
                <div class="form-section">
                    <h3>Recipient Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.recipient_first_name.label_tag }}
                            {{ form.recipient_first_name }}
                            {% if form.recipient_first_name.errors %}
                                <div class="error">{{ form.recipient_first_name.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.recipient_last_name.label_tag }}
                            {{ form.recipient_last_name }}
                            {% if form.recipient_last_name.errors %}
                                <div class="error">{{ form.recipient_last_name.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.recipient_email.label_tag }}
                            {{ form.recipient_email }}
                            {% if form.recipient_email.errors %}
                                <div class="error">{{ form.recipient_email.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.recipient_phone.label_tag }}
                            {{ form.recipient_phone }}
                            {% if form.recipient_phone.errors %}
                                <div class="error">{{ form.recipient_phone.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form.recipient_street.label_tag }}
                        {{ form.recipient_street }}
                        {% if form.recipient_street.errors %}
                            <div class="error">{{ form.recipient_street.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-row city-state-zip-row">
                        <div class="form-group city-field">
                            {{ form.recipient_city.label_tag }}
                            {{ form.recipient_city }}
                            {% if form.recipient_city.errors %}
                                <div class="error">{{ form.recipient_city.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group state-field">
                            {{ form.recipient_state.label_tag }}
                            {{ form.recipient_state }}
                            {% if form.recipient_state.errors %}
                                <div class="error">{{ form.recipient_state.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group zip-field">
                            {{ form.recipient_zip.label_tag }}
                            {{ form.recipient_zip }}
                            {% if form.recipient_zip.errors %}
                                <div class="error">{{ form.recipient_zip.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form.recipient_country.label_tag }}
                        {{ form.recipient_country }}
                        {% if form.recipient_country.errors %}
                            <div class="error">{{ form.recipient_country.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-section">
                    <h3>Package Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.box_size.label_tag }}
                            {{ form.box_size }}
                            {% if form.box_size.errors %}
                                <div class="error">{{ form.box_size.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.weight.label_tag }}
                            {{ form.weight }}
                            {% if form.weight.errors %}
                                <div class="error">{{ form.weight.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form.order_reference.label_tag }}
                        {{ form.order_reference }}
                        {% if form.order_reference.errors %}
                            <div class="error">{{ form.order_reference.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        {{ form.additional_info.label_tag }}
                        {{ form.additional_info }}
                        {% if form.additional_info.errors %}
                            <div class="error">{{ form.additional_info.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <button type="submit" class="submit-button">Submit Booking Request</button>
            </form>
        </div>
    </section>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Scroll to first error if there are validation errors
            const firstError = document.querySelector('.error, .alert-error');
            if (firstError) {
                // Scroll to the error with some offset for the fixed header
                const yOffset = -100; 
                const y = firstError.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({top: y, behavior: 'smooth'});
            }
            
            // Auto-hide messages after 5 seconds
            const messages = document.querySelectorAll('.alert-message');
            messages.forEach(function(message) {
                setTimeout(function() {
                    message.style.transition = 'opacity 0.5s ease-out';
                    message.style.opacity = '0';
                    setTimeout(function() {
                        message.remove();
                    }, 500);
                }, 5000);
            });
            
            // Check state availability
            const boxSizeSelect = document.getElementById('id_box_size');
            const stateInput = document.getElementById('id_recipient_state');
            
            function checkStateAvailability() {
                if (!stateInput) return;
                
                const state = stateInput.value.toUpperCase();
                const allowedStates = ['CA', 'CALIFORNIA', 'OR', 'OREGON', 'WA', 'WASHINGTON', 
                                      'CO', 'COLORADO', 'ID', 'IDAHO', 'AZ', 'ARIZONA'];
                
                // Remove any existing warnings
                const existingWarning = document.getElementById('state-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                // Only check if user has entered at least 2 characters
                if (state.length >= 2 && !allowedStates.includes(state)) {
                    let warningDiv = document.createElement('div');
                    warningDiv.id = 'state-warning';
                    warningDiv.style.cssText = 'background-color: #fee2e2; color: #dc2626; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.9rem;';
                    warningDiv.textContent = 'We are unable to ship to this location. Please contact support for assistance.';
                    stateInput.parentElement.appendChild(warningDiv);
                }
                // Check longboard availability for allowed states
                else if (boxSizeSelect && boxSizeSelect.value === 'longboard' && state) {
                    // All allowed states support longboard, so no additional check needed
                }
            }
            
            if (boxSizeSelect) {
                boxSizeSelect.addEventListener('change', checkStateAvailability);
            }
            if (stateInput) {
                stateInput.addEventListener('blur', checkStateAvailability);
                stateInput.addEventListener('input', checkStateAvailability);
            }
        });
    </script>
{% endblock %}